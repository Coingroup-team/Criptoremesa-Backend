<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Database Analysis Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script
      src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"
      defer
    ></script>
  </head>
  <body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8" x-data="databaseApp()">
      <!-- Header -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">
          Database Analysis Dashboard
        </h1>
        <p class="text-gray-600">Explore your PostgreSQL databases with ease</p>

        <div class="mt-4 flex space-x-4">
          <select
            x-model="currentDB"
            @change="loadTables()"
            class="px-3 py-2 border border-gray-300 rounded-md"
          >
            <option value="sixmap">Sixmap Database (253 tables)</option>
            <option value="criptoremesa">
              Criptoremesa Database (5 tables)
            </option>
          </select>

          <div class="text-sm text-gray-500 flex items-center">
            <span
              class="inline-block w-2 h-2 bg-green-500 rounded-full mr-2"
            ></span>
            <span x-text="status"></span>
          </div>
        </div>
      </div>

      <!-- Search Section -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-semibold mb-4">Search</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Search Tables</label
            >
            <div class="flex">
              <input
                type="text"
                x-model="tableSearch"
                @keyup.enter="searchTables()"
                placeholder="e.g., user, account, transaction"
                class="flex-1 px-3 py-2 border border-gray-300 rounded-l-md focus:ring-blue-500 focus:border-blue-500"
              />
              <button
                @click="searchTables()"
                class="px-4 py-2 bg-blue-600 text-white rounded-r-md hover:bg-blue-700"
              >
                Search
              </button>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Search Columns</label
            >
            <div class="flex">
              <input
                type="text"
                x-model="columnSearch"
                @keyup.enter="searchColumns()"
                placeholder="e.g., email, id, status"
                class="flex-1 px-3 py-2 border border-gray-300 rounded-l-md focus:ring-blue-500 focus:border-blue-500"
              />
              <button
                @click="searchColumns()"
                class="px-4 py-2 bg-green-600 text-white rounded-r-md hover:bg-green-700"
              >
                Search
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- SQL Query Section -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-semibold mb-4">SQL Query</h2>

        <textarea
          x-model="sqlQuery"
          rows="4"
          placeholder="SELECT * FROM sec_cust.ms_currencies LIMIT 10"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 font-mono"
        ></textarea>

        <div class="mt-4 flex justify-between items-center">
          <div class="flex space-x-2">
            <button
              @click="executeQuery()"
              class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700"
            >
              Execute Query
            </button>
            <button
              @click="sqlQuery = ''"
              class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600"
            >
              Clear
            </button>
          </div>

          <div class="text-sm text-gray-500">
            Database: <span class="font-medium" x-text="currentDB"></span>
          </div>
        </div>
      </div>

      <!-- Results Section -->
      <div
        class="bg-white rounded-lg shadow-md p-6"
        x-show="results.length > 0"
      >
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold">Results</h2>
          <span
            class="text-sm text-gray-500"
            x-text="`${results.length} items found`"
          ></span>
        </div>

        <!-- Table Results -->
        <template x-if="resultType === 'tables'">
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Table Name
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Rows
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Columns
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Actions
                  </th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                <template
                  x-for="table in results"
                  :key="table.table || table.name"
                >
                  <tr class="hover:bg-gray-50">
                    <td
                      class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900"
                    >
                      <span x-text="table.table || table.name"></span>
                    </td>
                    <td
                      class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"
                    >
                      <span
                        x-text="(table.rows || table.rowCount || 0).toLocaleString()"
                      ></span>
                    </td>
                    <td
                      class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"
                    >
                      <span
                        x-text="table.columns || table.columnCount || '-'"
                      ></span>
                    </td>
                    <td
                      class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"
                    >
                      <button
                        @click="describeTable(table.table || table.name)"
                        class="text-blue-600 hover:text-blue-900 mr-2"
                      >
                        Describe
                      </button>
                      <button
                        @click="sampleTable(table.table || table.name)"
                        class="text-green-600 hover:text-green-900"
                      >
                        Sample
                      </button>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </template>

        <!-- Column Results -->
        <template x-if="resultType === 'columns'">
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Table
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Column
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Type
                  </th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                <template
                  x-for="column in results"
                  :key="column.tableName + '.' + column.columnName"
                >
                  <tr class="hover:bg-gray-50">
                    <td
                      class="px-6 py-4 whitespace-nowrap text-sm text-gray-900"
                    >
                      <span x-text="column.tableName"></span>
                    </td>
                    <td
                      class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900"
                    >
                      <span x-text="column.columnName"></span>
                    </td>
                    <td
                      class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"
                    >
                      <span x-text="column.dataType"></span>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </template>

        <!-- Query Results -->
        <template x-if="resultType === 'query'">
          <div class="overflow-x-auto">
            <table
              class="min-w-full divide-y divide-gray-200"
              x-show="results.length > 0"
            >
              <thead class="bg-gray-50">
                <tr>
                  <template
                    x-for="column in Object.keys(results[0] || {})"
                    :key="column"
                  >
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      x-text="column"
                    ></th>
                  </template>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                <template x-for="(row, index) in results" :key="index">
                  <tr class="hover:bg-gray-50">
                    <template x-for="column in Object.keys(row)" :key="column">
                      <td
                        class="px-6 py-4 whitespace-nowrap text-sm text-gray-900"
                      >
                        <span
                          x-text="typeof row[column] === 'object' ? JSON.stringify(row[column]) : row[column]"
                        ></span>
                      </td>
                    </template>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </template>
      </div>

      <!-- Loading Indicator -->
      <div
        x-show="loading"
        class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50"
      >
        <div class="bg-white p-6 rounded-lg shadow-lg">
          <div
            class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"
          ></div>
          <p class="text-gray-600">Processing request...</p>
        </div>
      </div>
    </div>

    <script>
      function databaseApp() {
        return {
          currentDB: "sixmap",
          tableSearch: "",
          columnSearch: "",
          sqlQuery: "SELECT * FROM sec_cust.ms_currencies LIMIT 10",
          results: [],
          resultType: "",
          loading: false,
          status: "Connected",
          apiUrl: "http://localhost:3001/api",

          async apiCall(endpoint, options = {}) {
            this.loading = true;
            try {
              const response = await fetch(`${this.apiUrl}${endpoint}`, {
                headers: {
                  "Content-Type": "application/json",
                  ...options.headers,
                },
                ...options,
              });

              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }

              return await response.json();
            } catch (error) {
              alert("Error: " + error.message);
              throw error;
            } finally {
              this.loading = false;
            }
          },

          async searchTables() {
            if (!this.tableSearch.trim()) return;

            const data = await this.apiCall(
              `/tables/search?q=${encodeURIComponent(this.tableSearch)}&db=${
                this.currentDB
              }`
            );
            this.results = data.results || [];
            this.resultType = "tables";
          },

          async searchColumns() {
            if (!this.columnSearch.trim()) return;

            const data = await this.apiCall(
              `/columns/search?q=${encodeURIComponent(this.columnSearch)}&db=${
                this.currentDB
              }`
            );
            this.results = data.results || [];
            this.resultType = "columns";
          },

          async executeQuery() {
            if (!this.sqlQuery.trim()) return;

            const data = await this.apiCall("/query", {
              method: "POST",
              body: JSON.stringify({
                query: this.sqlQuery,
                database: this.currentDB,
                limit: 100,
              }),
            });

            this.results = data.data || [];
            this.resultType = "query";
          },

          async loadTables() {
            const data = await this.apiCall(`/tables?db=${this.currentDB}`);
            this.results = data.tables || [];
            this.resultType = "tables";
          },

          async describeTable(tableName) {
            alert(
              `Table: ${tableName}\n\nThis would show table structure. Use the CLI or API directly for detailed analysis.`
            );
          },

          async sampleTable(tableName) {
            try {
              const data = await this.apiCall(
                `/table/${encodeURIComponent(tableName)}/sample?db=${
                  this.currentDB
                }&size=5`
              );
              this.results = data.data || [];
              this.resultType = "query";
            } catch (error) {
              console.error("Error getting sample:", error);
            }
          },
        };
      }
    </script>
  </body>
</html>
